<div
  aria-haspopup="true"
  class={
    "dropdown feed_activity relative",
    "dropdown-end": @showing_within != :widget,
    "dropdown-top dropdown-end showing_within:widget": @showing_within == :widget
  }
>
  <button tabindex="0" class="btn btn-ghost btn-circle btn-sm">
    <Icon solid="DotsVertical" class="w-[18px] h-[18px] md:w-4 md:h-4 text-base-content/60" />
  </button>
  <ul
    tabindex="0"
    class="!block w-60 md:w-48 z-[910] relative shadow menu md:menu-compact dropdown-content bg-neutral rounded dropdown_actions"
    role="menu"
    aria-orientation="vertical"
    aria-labelledby="more-menu"
  >
    <#slot {@extra_items} />

    <Dynamic.Component
      :if={@object_boundary && module_enabled?(Bonfire.Boundaries.Web.PermissionsIconLive) &&
        @object_type not in [Bonfire.Data.Social.Message]}
      module={Bonfire.Boundaries.Web.PermissionsIconLive}
      object={@object}
      with_label
      id={ComponentID.new(Bonfire.Boundaries.Web.PermissionsIconLive, @object)}
      object_boundary={@object_boundary}
    />

    <li :if={module_enabled?(Bonfire.Classify.Web.TagModalLive)}>
      <Dynamic.Component module={Bonfire.Classify.Web.TagModalLive} object={@object} />
    </li>

    <!-- <li class="hover:bg-neutral hover:bg-opacity-20">
      <Bonfire.UI.Social.PinActionLive
        object={@object}
        class="flex items-center px-4 text-sm text-neutral-content/80"
      />
    </li>

    <li :if={Integration.is_admin?(@current_user) or Bonfire.Boundaries.can?(@current_user, :pin, :instance)}>
      <Bonfire.UI.Social.PinActionLive
        object={@object}
        class="flex items-center px-4 text-sm text-neutral-content/80"
        scope={:instance}
      />
    </li> -->

    <!-- Flag the action -->
    <li :if={current_user_id(@__context__) != subject_id(@activity, @object) and @verb != "Flag"}>
      <Bonfire.UI.Common.FlagActionLive
        object={@object}
        flagged={@flagged}
        label={l("Flag this %{object}", object: e(@object_type_readable, l("object")))}
        class="flex items-center text-sm text-neutral-content/80"
      />
    </li>

    <!-- Flag the author -->
    <li :if={(@verb != "Flag" and is_nil(@current_user)) or
      current_user_id(@__context__) != subject_id(@activity, @object)}>
      <Bonfire.UI.Common.FlagActionLive
        object={@object}
        flagged={@flagged}
        label={l("Flag %{name}", name: name(@activity, @object))}
        class="flex items-center py-2 text-sm text-neutral-content/80"
      />
    </li>

    <!-- Block the author & Block the author instance wide -->
    <Bonfire.Boundaries.Web.BlockMenuButtonsLive
      object={subject(@activity, @object)}
      peered={e(@object, :peered, nil)}
    />

    <!-- Delete the object -->
    <li :if={@object_boundary}>
      <Bonfire.UI.Social.Activity.DeleteObjectLive
        object={@object}
        creator_id={subject_id(@activity, @object)}
        object_type_readable={@object_type_readable}
        object_boundary={@object_boundary}
      />
    </li>

    <!-- Delete the activity -->
    <li :if={@object_boundary && @object_type not in [Bonfire.Data.Social.Message] && id(@activity)}>
      <Bonfire.UI.Social.Activity.DeleteObjectLive
        action="Bonfire.Social.Feeds:delete"
        object={@activity}
        object_boundary={@object_boundary}
        creator_id={subject_id(@activity, @object)}
        object_type_readable={l("from feeds")}
        creator_id={subject_id(@activity, @object)}
        explanation={l(
          "Deleting from feeds means this %{verb} and this %{object} still exist, but this activity won't be discoverable via the local instance's feeds. Remote feeds won't be affected.",
          object: e(@object_type_readable, l("object")),
          verb: @verb
        )}
      />
    </li>

    <#slot {@admin_items} />
  </ul>
</div>